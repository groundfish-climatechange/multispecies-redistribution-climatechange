---
title: "Species redistribution creates unequal outcomes for multispecies fisheries under projected climate change"
author: "Owen Liu"
date: '2022-07-05'
output: 
  html_document:
    toc: true
    toc_float: true
---

# Purpose

This script represents the main analysis and figure creation for the manuscript, "Species redistribution creates unequal outcomes for multispecies fisheries under projected climate change." Users can reproduce the analysis using the code blocks below, including figure creation. Any custom functions (e.g., any functions not directly sourced from the loaded R packages) are provided in `sdmTMB-model-functions.Rmd`. That script is sourced here.

```{r setup, include=FALSE}
# devtools::install_github("pbs-assess/sdmTMB")
library(sdmTMB)
library(tidyverse)
library(magrittr)
library(lubridate)
library(rnaturalearth)
library(sf)
library(here)
library(viridis)
# vista is Eric Ward's library for looking at outputs
library(vista)
library(cowplot)
library(ggalt)
library(RANN)
library(furrr)
library(future)
library(tictoc)
library(ggsci)
library(ggpubr)
library(ggnewscale)

knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform=FALSE)
```

```{r}
# set ggplot theme for plotting
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="sans",size=12,color="black"),
        legend.text = element_text(size=10),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=12,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
pal4 <- viridis_pal(option="A",begin=0.2,end=0.8)(4)
```

*A note on processing time: the species distribution models and other calculations in this analysis are complex, and can take a moderate amount of time to run---individual function calls can require a few minutes each (but not hours). To facilitate modularity in the code, we have included some saving and loading of files (usually `.rds` generic R data files). The point of these lines of code is, once the main models have been run once and the data files produced and saved, to provide the user with a way to interact with the faster parts of the code (e.g., plotting) without having to re-run the slower parts each time.*

# Load Data

Load the data for use in species distribution modeling and figure creation. The most raw versions of these data, and the code used to clean and organize them, are available from the authors upon request. One reason for this is that many of the raw data files (trawl survey data, ROMS oceanographic data) are very large before they are cleaned and summarized, and thus challenging to host on GitHub. Some data, particularly for creating the fishing footprints, are subject to data restrictions related to confidentiality, and were obtained by the authors through specific data sharing and non-disclosure agreements. Regardless, the data provided here should be sufficient to reproduce the models and figures in the manuscript.

```{r}
# Joined NWFSC trawl survey data and processed and matched CCROMS data for bottom temperature and oxygen
trawl_roms_utm <- read_rds(here::here('data','trawl_roms_joined.rds'))
```

```{r}
# CCROMS oceaongraphic data, pre-processed and clipped to projection extent
roms <- read_rds(here('data','roms_for_sdm_projection.rds'))

# Area of CCROMS cells
roms_area <- read_rds(here('data','roms_cell_area_km2.rds'))

# Latitude/longitude key for CCROMS grid cell centers
roms_ll <- read_rds(here::here('data','roms_latlon_depth_key_topleft_start.rds'))

# Distance from each CCROMS cell to the coastline
roms_dist_to_coast <- read_rds(here::here('data','roms_distance_to_shore.rds'))
```

```{r}
# Spatial data and mapping
# Extent of study area
projection_extent <- read_rds(here::here('data','cropped_domain_for_projected_sdms.rds'))
# 10km raster grid of the same extent
gr <- projection_extent %>% st_make_grid(cellsize=10,what='centers') %>% st_as_sf() %>% 
  st_intersection(projection_extent)
gr_xy <- st_coordinates(gr)

# coastline background map
coast <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington','Nevada')) %>%
  st_transform(crs = "+proj=utm +zone=10 +datum=WGS84 +units=km")

```

```{r}
# Trawl footprints for DTS species
footprints <- read_sf(here('data','DTS_footprints_combined.shp')) %>% 
  st_transform(st_crs(projection_extent)) %>% 
  filter(port_group %in% c("Astoria","Brookings","Crescent City","Eureka","Fort Bragg","Morro Bay", "Coos Bay")) %>% 
  mutate(port_name=factor(port_group,levels=c("Astoria","Coos Bay","Brookings","Crescent City","Eureka","Fort Bragg","Morro Bay")))
port_match <- tibble(port_name=c("Fort Bragg","Coos Bay","Astoria","Eureka","Morro Bay","North Puget Sound","Brookings","Crescent City")) %>%
  mutate(port_code=c("BRG","COS","AST","ERK","MRO","ANA","BRK","CRS"))

# Coordinates of focal ports for each port group
port_coords <- read_csv(here('data','port_coords.csv'),show_col_types = F) %>% 
  st_as_sf(coords=c("Lon","Lat"),crs=4326) %>% 
  st_transform(st_crs(projection_extent)) %>% 
  left_join(port_match,by="port_code") %>% 
  filter(port_name%in% unique(footprints$port_name)) %>% 
  mutate(port_name=factor(port_name,levels=c("Astoria","Coos Bay","Brookings","Crescent City","Eureka","Fort Bragg","Morro Bay")))
rm(port_match)

# CCROMS cells spatially matched to fishing footprints
roms_ports_match <- roms %>% 
  distinct(latitude,longitude) %>% 
  st_as_sf(coords=c("longitude","latitude"),crs="+proj=utm +zone=10 +datum=WGS84 +units=km",remove=F) %>% 
  st_join(footprints) %>% 
  st_set_geometry(NULL) %>% 
  drop_na() %>% 
  dplyr::select(latitude,longitude,port_group,port_name)
```

```{r}
# DTS species landings and value, from PacFIN
v <- read_csv(here('data','dts_landings.csv'),show_col_types = F) %>% 
  rename(name=`NMFS Name`) %>% 
  mutate(Year=as.integer(Year)) %>%
  mutate(lab=case_when(
    name=="SABLEFISH" ~ "Sablefish",
    name=="SOLE, DOVER" ~ "Dover Sole",
    name=="THORNYHEAD, LONGSPINE" ~ "Longspine",
    name=="THORNYHEAD, SHORTSPINE" ~ "Shortspine"
  )) %>% 
  mutate(lab=factor(lab,levels=c("Dover Sole","Sablefish","Shortspine","Longspine")))

# more detailed look relative to all other groundfish species, extracted by Sean Matson 12/2022
dts_landings <- read_csv(here('data','pacfin_dts_landings_matson.csv'))
```

# Load Functions

Load the custom functions used in both model fitting and figure creation.

```{r}
rmarkdown::render(here::here('scripts','sdmTMB-model-functions.Rmd'),quiet=TRUE)
```

# Model Species

Use `sdmTMB` to make ensemble models for each species of interest. If these models have already been run by the user and outputs saved, the cleaned and joined version of the outputs should be accessible by skipping down to the chunk labeled **Load**.

```{r,eval=F}
spp_to_model <- c("dover sole","sablefish","shortspine thornyhead","longspine thornyhead")
```

Run models and save cross-validation model stacking weights. (note: this chunk is turned to eval=F for now)

## Fit Models

```{r,eval=F}
for(i in 1:length(spp_to_model)){
  s <- spp_to_model[i]
  m <- model_species(s,data = trawl_roms_utm,use_substrate = F)
  write_rds(m,here::here('model output',paste(s,'models.rds')))
  print(paste(s,'models finished'))
}
```

## Make Predictions from Ensemble SDMs

Project ensemble species distribution models onto the 3 CCROMS-ESMs (IPSL, GFDL, and Hadley). For each, run 100 simulations with varying draws from the joint precision matrix, as described in the manuscript Methods.

```{r,eval=T}
dover_models <- read_rds(here::here('model output','dover sole models.rds'))
sable_models <- read_rds(here::here('model output','sablefish models.rds'))
ss_models <- read_rds(here::here('model output','shortspine thornyhead models.rds'))
ls_models <- read_rds(here::here('model output','longspine thornyhead models.rds'))
```

IPSL
```{r,eval=F}
dover_ens_ipsl <- ensemble_predictions(dover_models,gcm='ipsl',nsims=100)
sable_ens_ipsl <- ensemble_predictions(sable_models,gcm='ipsl',nsims=100)
ss_ens_ipsl <- ensemble_predictions(ss_models,gcm="ipsl",nsims=100)
ls_ens_ipsl <- ensemble_predictions(ls_models,gcm='ipsl',nsims=100)

write_rds(dover_ens_ipsl,here('model output','dover_ensemble_preds_ipsl.rds'))
write_rds(sable_ens_ipsl,here('model output','sable_ensemble_preds_ipsl.rds'))
write_rds(ss_ens_ipsl,here('model output','ss_ensemble_preds_ipsl.rds'))
write_rds(ls_ens_ipsl,here('model output','ls_ensemble_preds_ipsl.rds'))
```

GFDL
```{r,eval=F}
dover_ens_gfdl <- ensemble_predictions(dover_models,gcm='gfdl',nsims=100)
write_rds(dover_ens_gfdl,here('model output','dover_ensemble_preds_gfdl.rds'))
sable_ens_gfdl <- ensemble_predictions(sable_models,gcm='gfdl',nsims=100)
write_rds(sable_ens_gfdl,here('model output','sable_ensemble_preds_gfdl.rds'))
ss_ens_gfdl <- ensemble_predictions(ss_models,gcm="gfdl",nsims=100)
write_rds(ss_ens_gfdl,here('model output','ss_ensemble_preds_gfdl.rds'))
ls_ens_gfdl <- ensemble_predictions(ls_models,gcm='gfdl',nsims=100)
write_rds(ls_ens_gfdl,here('model output','ls_ensemble_preds_gfdl.rds'))

```

Hadley
```{r,eval=F}
dover_ens_hadl <- ensemble_predictions(dover_models,gcm='hadl',nsims=100)
sable_ens_hadl <- ensemble_predictions(sable_models,gcm='hadl',nsims=100)
ss_ens_hadl <- ensemble_predictions(ss_models,gcm="hadl",nsims=100)
ls_ens_hadl <- ensemble_predictions(ls_models,gcm='hadl',nsims=100)

write_rds(dover_ens_hadl,here('model output','dover_ensemble_preds_hadl.rds'))
write_rds(sable_ens_hadl,here('model output','sable_ensemble_preds_hadl.rds'))
write_rds(ss_ens_hadl,here('model output','ss_ensemble_preds_hadl.rds'))
write_rds(ls_ens_hadl,here('model output','ls_ensemble_preds_hadl.rds'))
```

### Join 3 ESM Predictions

Join the 3 projected datasets for each species. We join these projected datasets in a couple of different ways to facilitate different kinds of plotting later.

```{r,eval=F}
dover_ens_sims <-list(dover_ens_gfdl,dover_ens_ipsl,dover_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='dover')

sable_ens_sims <-list(sable_ens_gfdl,sable_ens_ipsl,sable_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='sable')

ss_ens_sims <-list(ss_ens_gfdl,ss_ens_ipsl,ss_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='ss')

ls_ens_sims <-list(ls_ens_gfdl,ls_ens_ipsl,ls_ens_hadl) %>% bind_rows() %>% 
    dplyr::select(-esm) %>% 
    group_by(year,longitude,latitude,lat,lon,depth_m) %>%
    nest() %>% 
    ungroup() %>% 
    mutate(data=purrr::map(data,function(x)as.numeric(as.matrix(x))),
           species='ls')

write_rds(sable_ens_sims,here('model output','sable_ensemble_all_sims.rds'))
write_rds(dover_ens_sims,here('model output','dover_ensemble_all_sims.rds'))
write_rds(ss_ens_sims,here('model output','ss_ensemble_all_sims.rds'))
write_rds(ls_ens_sims,here('model output','ls_ensemble_all_sims.rds'))
```

Same as the above, but join all 3 CCROMS-ESMs together, and calculate summary statistics (median, mean, 5th and 95th quantiles) for each combination of year and location.

```{r,eval=F}
dover_ens_all <- purrr::map_df(list(dover_ens_gfdl,dover_ens_ipsl,dover_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

sable_ens_all <- purrr::map_df(list(sable_ens_gfdl,sable_ens_ipsl,sable_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

ss_ens_all <- purrr::map_df(list(ss_ens_gfdl,ss_ens_ipsl,ss_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

ls_ens_all <- purrr::map_df(list(ls_ens_gfdl,ls_ens_ipsl,ls_ens_hadl),function(df){
  df %>% pivot_longer(contains('sim'),names_to="sim",values_to="est")
}) %>% 
  group_by(year,longitude,latitude,lat,lon,depth_m) %>% 
  summarise(median_est=median(est),mean_est=mean(est),est5=quantile(est,0.05),est95=quantile(est,0.95)) %>% 
  ungroup()

write_rds(sable_ens_all,here('model output','sable_ensemble_preds_combined.rds'))
write_rds(dover_ens_all,here('model output','dover_ensemble_preds_combined.rds'))
write_rds(ss_ens_all,here('model output','ss_ensemble_preds_combined.rds'))
write_rds(ls_ens_all,here('model output','ls_ensemble_preds_combined.rds'))
```

### Ensemble Abundance Index

Create ensemble indices of abundance.

```{r,eval=F}
tic("Dover indices:")
dover_ind_ipsl <- make_index_sims(dover_models,gcm="ipsl")
dover_ind_gfdl <- make_index_sims(dover_models,gcm="gfdl")
dover_ind_hadl <- make_index_sims(dover_models,gcm="hadl")
dover_ind_all <- dover_ind_ipsl %>% 
  bind_rows(dover_ind_gfdl) %>% 
  bind_rows(dover_ind_hadl)
toc()

tic("Sablefish indices:")
sable_ind_ipsl <- make_index_sims(sable_models,gcm="ipsl")
sable_ind_gfdl <- make_index_sims(sable_models,gcm="gfdl")
sable_ind_hadl <- make_index_sims(sable_models,gcm="hadl")
sable_ind_all <- sable_ind_ipsl %>% 
  bind_rows(sable_ind_gfdl) %>% 
  bind_rows(sable_ind_hadl)
toc()

tic("Shortspine indices:")
ss_ind_ipsl <- make_index_sims(ss_models,gcm="ipsl")
ss_ind_gfdl <- make_index_sims(ss_models,gcm="gfdl")
ss_ind_hadl <- make_index_sims(ss_models,gcm="hadl")
ss_ind_all <- ss_ind_ipsl %>% 
  bind_rows(ss_ind_gfdl) %>% 
  bind_rows(ss_ind_hadl)
toc()

tic("Longspine indices:")
ls_ind_ipsl <- make_index_sims(ls_models,gcm="ipsl")
ls_ind_gfdl <- make_index_sims(ls_models,gcm="gfdl")
ls_ind_hadl <- make_index_sims(ls_models,gcm="hadl")
ls_ind_all <- ls_ind_ipsl %>% 
  bind_rows(ls_ind_gfdl) %>% 
  bind_rows(ls_ind_hadl)
toc()
```

```{r,eval=F}
write_rds(sable_ind_all,here('model output','sable_abun_indices.rds'))
write_rds(dover_ind_all,here('model output','dover_abun_indices.rds'))
write_rds(ss_ind_all,here('model output','ss_abun_indices.rds'))
write_rds(ls_ind_all,here('model output','ls_abun_indices.rds'))
```

### Load

```{r}
# separate projections, with sims
dover_ens_separate <- list.files(here('model output'),full.names = T) %>% 
  str_subset('dover_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)
sable_ens_separate <- list.files(here('model output'),full.names = T) %>%
  str_subset('sable_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)
ss_ens_separate <- list.files(here('model output'),full.names = T) %>%
  str_subset('ss_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)
ls_ens_separate <- list.files(here('model output'),full.names = T) %>%
  str_subset('ls_ensemble_preds') %>% 
  str_subset("combined",negate=T) %>% map_df(read_rds)

# combined across ESMs
dover_ens_all <- read_rds(here('model output','dover_ensemble_preds_combined.rds')) %>% 
  mutate(species='dover')
sable_ens_all <- read_rds(here('model output','sable_ensemble_preds_combined.rds'))%>% 
  mutate(species='sable')
ss_ens_all <- read_rds(here('model output','ss_ensemble_preds_combined.rds'))%>% 
  mutate(species='ss')
ls_ens_all <- read_rds(here('model output','ls_ensemble_preds_combined.rds'))%>% 
  mutate(species='ls')

# with sims
dover_ens_sims <- read_rds(here('model output','dover_ensemble_all_sims.rds'))
sable_ens_sims <- read_rds(here('model output','sable_ensemble_all_sims.rds'))
ss_ens_sims <- read_rds(here('model output','ss_ensemble_all_sims.rds'))
ls_ens_sims <- read_rds(here('model output','ls_ensemble_all_sims.rds'))

# Join. We need the data in slightly different forms for different analyses
# separate ESMs
four_spp_list <- list("dover"=dover_ens_separate,
                      "sable"=sable_ens_separate,
                      "ss"=ss_ens_separate,
                      "ls"=ls_ens_separate)

# combined ensemble abundance
four_spp <- list(dover_ens_all,sable_ens_all,ss_ens_all,ls_ens_all) %>% bind_rows() %>% 
  # join roms data
  left_join(roms,by = c("year", "longitude", "latitude", "lat", "lon"))
```

```{r}
# Load abundance indices
sable_ind_all<-read_rds(here('model output','sable_abun_indices.rds'))
dover_ind_all<-read_rds(here('model output','dover_abun_indices.rds'))
ss_ind_all<-read_rds(here('model output','ss_abun_indices.rds'))
ls_ind_all<-read_rds(here('model output','ls_abun_indices.rds'))
```

## Model Fit Visualization

### Deviance Explained
Using the fitted models and a intercept-only null model for each species, calculate the percent deviance explained to add to the reported model statistics
```{r}
dover_dev <- calc_deviance_ensemble(dover_models)
sable_dev <- calc_deviance_ensemble(sable_models)
ss_dev <- calc_deviance_ensemble(ss_models)
ls_dev <- calc_deviance_ensemble(ls_models)
```


### Model Tables

Model fit tables for the Appendix

```{r}
dover_fit_table <- report_model_ensemble(dover_models)
sable_fit_table <- report_model_ensemble(sable_models)
ss_fit_table <- report_model_ensemble(ss_models)
ls_fit_table <- report_model_ensemble(ls_models)

write_csv(dover_fit_table,here('model output','dover_fit_table.csv'))
write_csv(sable_fit_table,here('model output','sable_fit_table.csv'))
write_csv(ss_fit_table,here('model output','ss_fit_table.csv'))
write_csv(ls_fit_table,here('model output','ls_fit_table.csv'))
```

### QQ plots

QQ plots for the Appendix.

```{r}
doverqq = make_qq_plots(dover_models)
sableqq = make_qq_plots(sable_models)
ssqq = make_qq_plots(ss_models)
lsqq = make_qq_plots(ls_models)

ggsave(here('model output','dover_qq.png'),doverqq,h=3,w=8)
ggsave(here('model output','sable_qq.png'),sableqq,h=3,w=8)
ggsave(here('model output','ss_qq.png'),ssqq,h=3,w=8)
ggsave(here('model output','ls_qq.png'),lsqq,h=3,w=8)
```

### Weighted Spatial Residuals

```{r}
dover_resids <- map_weighted_residuals(dover_models)
sable_resids <- map_weighted_residuals(sable_models)
ss_resids <- map_weighted_residuals(ss_models)
ls_resids <- map_weighted_residuals(ls_models)

ggsave(here('model output','dover_resid.png'),dover_resids,h=6,w=4)
ggsave(here('model output','sable_resid.png'),sable_resids,h=6,w=4)
ggsave(here('model output','ss_resid.png'),ss_resids,h=6,w=4)
ggsave(here('model output','ls_resid.png'),ls_resids,h=6,w=4)
```


### Environmental Niches

Environmental niches for each species separately, for the Appendix.

```{r}
dover_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='dover sole',
                           simsdf=dover_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

sable_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='sablefish',
                           simsdf=sable_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

ss_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='shortspine',
                        simsdf=ss_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

ls_niches <- purrr::map(c('gfdl','ipsl','hadl'),make_fitted_env_niches,sppname='longspine',
                        simsdf=ls_ens_separate) %>% plot_grid(plotlist=.,nrow=1)

ggsave(here('model output','dover_envir_niche.png'),dover_niches,h=6,w=8)
ggsave(here('model output','sable_envir_niche.png'),sable_niches,h=6,w=8)
ggsave(here('model output','ss_envir_niche.png'),ss_niches,h=6,w=8)
ggsave(here('model output','ls_envir_niche.png'),ls_niches,h=6,w=8)

```

# Manuscript Figures

## Figure 1

```{r,fig.height=4,fig.width=3}
fourspp_ind_all <- dover_ind_all %>% mutate(spp="Dover sole") %>% 
  bind_rows(sable_ind_all %>% mutate(spp="Sablefish")) %>% 
  bind_rows(ss_ind_all %>% mutate(spp="Shortspine thornyhead")) %>% 
  bind_rows(ls_ind_all %>% mutate(spp="Longspine thornyhead")) %>% 
  mutate(spp=factor(spp,levels=c("Dover sole","Sablefish","Shortspine thornyhead","Longspine thornyhead")))

# get a sense for historical variability (5th and 95th% quantiles)
fourspp_ind_range <- fourspp_ind_all %>% 
  filter(year%in%c(1985:2010)) %>% 
  group_by(spp) %>% 
  mutate(upper=wtd.log_est_smooth+wtd.se_est_smooth,
         lower=wtd.log_est_smooth-wtd.se_est_smooth) %>% 
  summarise(h5=quantile(lower,0.05,na.rm=T),
            h95=quantile(upper,0.95,na.rm=T))

fourspp_ind_plot <- ggplot()+
  geom_ribbon(data=fourspp_ind_all,
              aes(year,wtd.log_est_smooth,
             ymin=wtd.log_est_smooth-wtd.se_est_smooth,
             ymax=wtd.log_est_smooth+wtd.se_est_smooth,
             group=esm),
             fill='gray80',
             alpha=0.5,linetype=0)+
  geom_line(data=fourspp_ind_all,
            aes(year,wtd.log_est_smooth,
            color=esm),
            size=1.5)+
  geom_linerange(data=fourspp_ind_range,
                 aes(ymin=h5,ymax=h95),x=2021,size=2.5)+
  geom_linerange(data=fourspp_ind_range,
                 aes(ymin=h5,ymax=h95),x=2100,size=2.5)+
  scale_x_continuous(limits=c(2021,2100),expand=c(0,0))+
  facet_wrap(~spp,nrow=4,scales='free_y')+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  scale_fill_manual(values=c("#009175","#7E0018","#00C2F9"))+
  labs(x="Year",y="Coastwide Index of Abundance",color="ESM",fill="ESM")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        legend.position = 'bottom',
        axis.text.x = element_text(angle=30,vjust=1,hjust=1),
        strip.text = element_text(size=12))

fourspp_ind_fig <- ggdraw()+
  draw_plot(fourspp_ind_plot)+
  draw_image(here('data','icons','dover_sil.png'),hjust=.17,vjust=-.41,scale=0.23)+
  draw_image(here('data','icons','sablefish_sil.png'),hjust=.17,vjust=-.1,scale=0.25)+
  draw_image(here('data','icons','shortspine_sil.png'),hjust=.17,vjust=.1,scale=0.26)+
  draw_image(here('data','icons','longspine_sil.png'),hjust=.17,vjust=.22,scale=0.23)
```

Coastwide environmental change

```{r,fig.height=7,fig.width=3}
coast_t_o_hist <- roms %>% 
  dplyr::select(mean_bt_30d_ipsl,mean_bt_30d_gfdl,mean_bt_30d_hadl,
                mean_oxy_bottom_30d_ipsl,mean_oxy_bottom_30d_gfdl, mean_oxy_bottom_30d_hadl,
                latitude,longitude,year) %>% 
  filter(year%in%c(1985:2010)) %>%
  # ensemble mean values
  mutate(oxy_ens=(mean_oxy_bottom_30d_ipsl+mean_oxy_bottom_30d_gfdl+mean_oxy_bottom_30d_hadl)/3,
         t_ens=(mean_bt_30d_ipsl+mean_bt_30d_gfdl+mean_bt_30d_hadl)/3) %>% 
  group_by(longitude,latitude) %>%
  summarise(t=mean(t_ens),
            oxy=mean(oxy_ens)) %>% 
  ungroup()

coast_t_o_fut <- roms %>% 
  dplyr::select(mean_bt_30d_ipsl,mean_bt_30d_gfdl,mean_bt_30d_hadl,
                mean_oxy_bottom_30d_ipsl,mean_oxy_bottom_30d_gfdl, mean_oxy_bottom_30d_hadl,
                latitude,longitude,year) %>% 
  filter(year%in%c(2075:2100)) %>% 
  # ensemble mean values
  mutate(oxy_ens=(mean_oxy_bottom_30d_ipsl+mean_oxy_bottom_30d_gfdl+mean_oxy_bottom_30d_hadl)/3,
         t_ens=(mean_bt_30d_ipsl+mean_bt_30d_gfdl+mean_bt_30d_hadl)/3) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t_fut=mean(t_ens),
            oxy_fut=mean(oxy_ens)) %>% 
  ungroup()

coast_t_o <- coast_t_o_hist %>% 
  left_join(coast_t_o_fut,by=c("longitude","latitude")) %>% 
  mutate(diff_t=t_fut-t,diff_o=oxy_fut-oxy)

pred_points <- coast_t_o %>% dplyr::select(longitude,latitude) %>% as.matrix()
nns <- nn2(pred_points,gr_xy,k=1)$nn.idx
t_o_grid <- gr_xy %>% as_tibble() %>% mutate(diff_t=coast_t_o$diff_t[nns],diff_o=coast_t_o$diff_o[nns])

coast_t_plot <- t_o_grid %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_t))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"T")))+
  theme(legend.position = c(0.4,0.6))

coast_o_plot <- t_o_grid %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_o))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"O")))+
  theme(legend.position = c(0.4,0.6))

coast_t_o_plot <- plot_grid(coast_t_plot,NULL,coast_o_plot,ncol=1,rel_heights = c(1,-0.1,1))
```

```{r,fig.height=7,fig.width=6.5}
fig1 <- plot_grid(coast_t_o_plot,NULL,fourspp_ind_fig,ncol=3,labels=c('a','','b'),rel_widths = c(0.8,-0.1,1))
fig1
ggsave(here('model output','fig1.png'),fig1,w=6.5,h=7)
```

## Figure 2

Weighted distance from shore

```{r}
fourspp_reldist <- purrr::map(four_spp_list,calc_rel_dist_to_shore)
fourspp_reldist <- bind_rows(fourspp_reldist,.id='species')

#historical average
fourspp_reldist_hist <- fourspp_reldist %>% 
  filter(year %in% c(1985:2010)) %>% 
  group_by(species,lat,esm,sim) %>% 
  summarise(mean_dist_hist=mean(dist)) %>% 
  ungroup()

# end of century
fourspp_reldist_fut <- fourspp_reldist %>% 
  filter(year %in% c(2075:2100)) %>% 
  group_by(species,lat,esm,sim) %>% 
  summarise(mean_dist_fut=mean(dist)) %>% 
  ungroup()

# bind again
fourspp_reldist_change <- fourspp_reldist_hist %>% 
  left_join(fourspp_reldist_fut,by=c('species','lat','esm','sim')) %>%
  mutate(change=mean_dist_fut-mean_dist_hist) %>%
  # add some plotting helpers
    mutate(spp_plotting=case_when(
      species=='dover' ~ "Dover Sole",
      species=="ls" ~ "Longspine",
      species=="ss"~"Shortspine",
      species=="sable" ~"Sablefish"
    )) %>% 
    mutate(spp_plotting=factor(spp_plotting,levels=c("Dover Sole","Sablefish","Shortspine","Longspine"))) %>% 
  mutate(ESM=toupper(esm))
```

```{r}
four_spp_dist_to_shore_change <- fourspp_reldist_change %>% 
  group_by(spp_plotting,lat,esm) %>% 
  slice_sample(n=25) %>% 
  ggplot(aes(x=lat,y=change,fill=ESM,col=ESM))+
  # geom_point(color='gray80',alpha=0.2,size=0.7)+
  geom_point(size=0.5,alpha=0.2,position = position_jitter())+
  geom_hline(yintercept=0,linetype=2)+
  geom_smooth(data=fourspp_reldist_change,
             aes(x=lat,y=change,fill=ESM,col=ESM),se=F)+
  # geom_point(data=fp_lat,aes(x=lat,y=-20),color='black',size=2)+
  scale_y_continuous(limits=c(-20,20))+
  facet_wrap(~spp_plotting,nrow=1)+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  scale_fill_manual(values=c("#009175","#7E0018","#00C2F9"))+
  coord_flip()+
  # theme(legend.position = c(0.8,0.7))+
  labs(y="Change in Distance from Shore (km)",x="Latitude",col="ESM",fill="ESM")+
  theme(panel.background = element_rect(fill=NA,color='black'),
        strip.text=element_text(size=12))
```
Depth change

```{r}
fourspp_depth <- purrr::map(four_spp_list,calc_depth_frac,start_year=2020,end_year=2100) %>% bind_rows(.id='species')

fourspp_depth_plot <- fourspp_depth %>% 
    mutate(spp_plotting=case_when(
      species=='dover' ~ "Dover Sole",
      species=="ls" ~ "Longspine",
      species=="ss"~"Shortspine",
      species=="sable" ~"Sablefish"
    )) %>% 
    mutate(spp_plotting=factor(spp_plotting,levels=c("Dover Sole","Sablefish","Shortspine","Longspine"))) %>% 
  mutate(ESM=toupper(esm)) %>% 
  group_by(species,year,esm) %>% 
  slice_sample(n=25) %>% 
  ungroup() %>% 
  ggplot(aes(x=year,y=frac,col=ESM,fill=ESM))+
  geom_point(size=0.5,alpha=0.2,position = position_jitter())+
  geom_smooth(se=F)+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  scale_fill_manual(values=c("#009175","#7E0018","#00C2F9"))+
  facet_wrap(~spp_plotting,nrow=1)+
  # scale_color_manual(values=c("#2271B2","#d55e00"))+
  labs(x="Year",y="Proportion < 700 fathoms",title="",fill="ESM",col="ESM")+
  theme(axis.text.x = element_text(angle=30,vjust=1,hjust=1),
        panel.background = element_rect(fill=NA,color='black'),
        strip.text=element_blank(),
        legend.position="bottom")
```

```{r,fig.width=8,fig.height=7.5}
dist_to_shore_fig <- ggdraw()+
  draw_plot(four_spp_dist_to_shore_change+theme(plot.margin=unit(c(0.5,0.5,0.1,0.5),'cm'))+guides(color='none',fill='none'))

depth_change_fig <- ggdraw()+
  draw_plot(fourspp_depth_plot + guides(color='none',fill='none') + theme(plot.margin=unit(c(0,0.5,1.5,0.5),'cm')))+
  draw_image(here('data','icons','dover_sil.png'),hjust=.36,vjust=0.15,scale=0.10)+
  draw_image(here('data','icons','sablefish_sil.png'),hjust=.11,vjust=0.15,scale=0.14)+
  draw_image(here('data','icons','shortspine_sil.png'),hjust=-.1,vjust=0.15,scale=0.15)+
  draw_image(here('data','icons','longspine_sil.png'),hjust=-.32,vjust=0.15,scale=0.12)

leg <- get_legend(fourspp_depth_plot)

fig_dist_depth_change<-plot_grid(dist_to_shore_fig, depth_change_fig,
                                 nrow=2,labels='auto')

fig_dist_depth_change<-ggdraw()+
  draw_plot(fig_dist_depth_change)+
  draw_plot(leg,y=-0.45)

fig_dist_depth_change

ggsave(here('model output','fig2.png'),fig_dist_depth_change,w=8,h=7.5)
```

## Figure 3

Fishing footprints map

```{r}
bbox=st_bbox(projection_extent)
footprints_map <- ggplot()+
  geom_sf(data=footprints,aes(fill=port_name),alpha=0.5)+
  geom_sf(data=coast,col=NA,fill='gray80')+
  geom_sf(data=port_coords,aes(color=port_name),size=3)+
  scale_fill_npg()+
  scale_color_npg()+
  guides(color='none')+
  # guides(color="none",fill='none')+
  coord_sf(datum=NA)+
  labs(fill="Port")+
  xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
  theme(
        legend.text=element_text(size=8),
        legend.background = element_rect(fill='white',color='black'),
        legend.position=c(0.7,0.65))
```

Environmental state space within fishing footprints.

```{r}
roms_env_space <- roms %>% 
  dplyr::select(year,lat,lon,mean_bt_30d_hadl,mean_oxy_bottom_30d_hadl,
                mean_bt_30d_gfdl,mean_oxy_bottom_30d_gfdl,
                mean_bt_30d_ipsl,mean_oxy_bottom_30d_ipsl) %>% 
  mutate(oxy_ens=(mean_oxy_bottom_30d_ipsl+mean_oxy_bottom_30d_gfdl+mean_oxy_bottom_30d_hadl)/3,
         t_ens=(mean_bt_30d_ipsl+mean_bt_30d_gfdl+mean_bt_30d_hadl)/3) %>% 
  distinct() %>%
  left_join(roms_ll,by=c('lon','lat')) %>% 
  drop_na() %>% 
  rename(t=t_ens,oxy=oxy_ens) %>% 
  mutate(depth_bin=cut(depth_m,breaks=c(0,-100,-250,-500,-1000,-3000),
                       labels=c("1000-3000m","500-1000m","250-500m","100-250m","0-100m")),
         lat_bin=cut(lat,breaks=c(30,33,36,39,42,45,48),labels=c("30-33","33-36","36-39","39-42","42-45","45-48")))
roms_env_space_hist <- roms_env_space %>%
  # historical "mean" is 1985-2010
  filter(year%in%c(1985:2010)) %>%
  group_by(lat,lon,roms_cell,depth_m,depth_bin,lat_bin) %>% 
  summarise(t_hist=mean(t,na.rm=T),oxy_hist=mean(oxy,na.rm=T)) %>% 
  ungroup()

roms_env_space_fut <- roms_env_space %>%
  # historical "mean" is 1985-2010
  filter(year%in%c(2075:2100)) %>%
  group_by(lat,lon,roms_cell,depth_m,depth_bin,lat_bin) %>% 
  summarise(t_fut=mean(t,na.rm=T),oxy_fut=mean(oxy,na.rm=T)) %>% 
  ungroup()

roms_env_space_sf <- roms_env_space_hist %>% 
  left_join(roms_env_space_fut, c("lat", "lon", "roms_cell", "depth_m", "depth_bin", "lat_bin")) %>%
  st_as_sf(coords=c('lon','lat'),crs=4326) %>% 
  st_transform(st_crs(footprints)) %>% 
  st_join(footprints)

footprint_env_space <- roms_env_space_sf %>% 
  drop_na() %>% 
  group_by(port_name,port_group) %>% 
  summarise(mean_t_hist=mean(t_hist),mean_oxy_hist=mean(oxy_hist),
            mean_t_fut=mean(t_fut),mean_oxy_fut=mean(oxy_fut)) %>% 
  ungroup()

# mean across the entire CCROMS domain
roms_env_change_mean <- roms_env_space_sf %>% 
  st_set_geometry(NULL) %>% 
  distinct() %>% 
  summarise(mean_t_hist=mean(t_hist),mean_oxy_hist=mean(oxy_hist),
            mean_t_fut=mean(t_fut),mean_oxy_fut=mean(oxy_fut)) %>% 
  mutate(port_name="Coastwide")
footprint_env_space <- footprint_env_space %>% bind_rows(roms_env_change_mean) %>% 
  mutate(port_name=factor(port_name,levels=c("Coastwide","Astoria","Coos Bay","Brookings","Crescent City","Eureka","Fort Bragg","Morro Bay")))
```

Make environmental affinities ellipses for species

```{r}
aff_polys<-affinities_ellipses_ens(four_spp,yr_vec=1985:2010,concavity=5,threshold=0.25,lt=50)
# need to use new_scale_color() here to have multiple color scales for different pieces of the figure
polys_and_footprints <- ggplot()+
  geom_polygon(data=aff_polys,aes(V1,V2,col=spp_plotting,linetype=spp_plotting),fill=NA,size=1)+
  scale_linetype_manual(values=c(1:4),guide='none')+
  scale_color_manual(values=c(pal4),name="Top 75% of\nspecies' CPUE")+
  new_scale_color()+
  geom_segment(data=footprint_env_space,aes(x=mean_t_hist,y=mean_oxy_hist,xend=mean_t_fut,yend=mean_oxy_fut,
             col=port_name),size=1,linetype=1,arrow=ggplot2::arrow(type="open",length=unit(0.1,'inches')))+
  scale_color_manual(name="Port Group\nClimate",values=c('gray50',pal_npg()(7)))+
  labs(x="Bottom Temperature (deg C)",y="Bottom Oxygen (mmol/m3)")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor=element_blank(),
        panel.border = element_rect(color='black',fill=NA),
        axis.text=element_text(size=12))
```

```{r}
# with fish icons
polys_and_footprints_fig <- ggdraw()+
  draw_plot(polys_and_footprints)+
  draw_image(here('data','icons','dover_sil.png'),hjust=0.05,vjust=-.4,scale=0.12)+
  draw_image(here('data','icons','sablefish_sil.png'),hjust=.10,vjust=-.17,scale=0.15)+
  draw_image(here('data','icons','shortspine_sil.png'),hjust=.14,vjust=-.03,scale=0.15)+
  draw_image(here('data','icons','longspine_sil.png'),hjust=.23,vjust=.08,scale=0.13)
```


```{r}
footprint_db_temp_plot <- footprint_env_space %>% 
  ggplot(aes(x=mean_t_hist,xend=mean_t_fut,y=fct_rev(port_name),yend=fct_rev(port_name),col=port_name))+
  geom_segment(col="#A50F15",size=1,linetype=1,arrow=ggplot2::arrow(type="closed",length=unit(0.1,'inches')))+
  labs(x="Temperature",y="")+
  scale_y_discrete(position='right')+
  theme(panel.border = element_rect(color='black',fill=NA),
        axis.text.y=element_text(color=c(rev(pal_npg()(7)),'gray50')))

footprint_db_oxy_plot <- footprint_env_space %>% 
  ggplot(aes(x=mean_oxy_hist,xend=mean_oxy_fut,y=fct_rev(port_name),yend=fct_rev(port_name),col=port_name))+
  geom_segment(col="#0e668b",size=1,linetype=1,arrow=ggplot2::arrow(type="closed",length=unit(0.1,'inches')))+
  labs(x="Oxygen",y="")+
  theme(axis.text.y = element_blank(),panel.border = element_rect(color='black',fill=NA))

# footprint_db_oxy_plot
footprint_env_change_map <- plot_grid(footprints_map,NULL,footprint_db_oxy_plot,footprint_db_temp_plot,ncol=4,rel_widths = c(0.6,-0.1,0.45,0.6),labels=c('a','','b','c'),hjust=c(-0.5,0,-0.5,0.4))
```

```{r,fig.height=8,fig.width=8}
fig3 <- plot_grid(footprint_env_change_map,polys_and_footprints_fig,labels=c("",'d'),nrow=2,
                  hjust = 0,vjust=1,
                  rel_heights = c(0.5,0.5))
fig3
ggsave(here('model output','fig3.png'),fig3,height=9,width=8,units='in')
```

## Figure 4

CPUE/density timeseries

```{r}
allspp_reldens <- purrr::map2_df(list(dover_ens_separate,sable_ens_separate,ss_ens_separate,ls_ens_separate),
                                 c('dover','sable','shortspine','longspine'),
                                 function(x,y){
                                   calc_footprint_reldens_sims(x) %>% mutate(spp=y)
                                 }) %>%
  mutate(ESM=toupper(esm)) %>% 
  mutate(spp_plotting=case_when(
      spp=='dover' ~ "Dover Sole",
      spp=="longspine" ~ "Longspine",
      spp=="shortspine"~"Shortspine",
      spp=="sable" ~"Sablefish"
    )) %>% 
  mutate(spp_plotting=factor(spp_plotting,levels=c("Sablefish","Dover Sole","Shortspine","Longspine"))) %>%
  drop_na()
```

```{r}
# Plot dover and sablefish relative density change within Astoria and Fort Bragg footprints
dover_sable_reldens <- allspp_reldens %>% 
  filter(spp %in% c('dover','sable'),
         port_name%in%c('Astoria','Fort Bragg')) %>% 
  ggplot(aes(delta_perc,fill=ESM))+
  geom_density(alpha=0.5)+
  geom_vline(xintercept=0,linetype=2)+
  # scale_color_manual(values=c("#009175","#7E0018","#00C2F9"))+
  scale_fill_manual(values=c("#009175","#7E0018","#00C2F9"))+
  facet_grid(spp_plotting~port_name)+
  labs(x=expression(paste(Delta,"CPUE")),y="Kernel Density",fill="")+
  theme(legend.position = 'bottom',
        strip.text = element_text(size=10),
        panel.background = element_rect(color='black'))
```

Bhattacharyya's coefficient

```{r}
# calculate Bhattacharyya's coefficient using Dover sole and sablefish projections
dover_sable_bhat <- bhat_sims(dover_ens_separate,sable_ens_separate)

# historical overlap, 1985-2010
dover_sable_bhat_hist <- dover_sable_bhat %>%
  filter(year %in% c(1985:2010)) %>%
  group_by(port_name,esm,sim) %>%
  summarise(bhat_hist=mean(bhat)) %>%
  ungroup()

# projected future overlap, 2075-21000
dover_sable_bhat_fut <- dover_sable_bhat %>%
  filter(year %in% c(2075:2100)) %>%
  group_by(port_name,esm,sim) %>%
  summarise(bhat_fut=mean(bhat)) %>%
  ungroup()

# difference between past and future
dover_sable_bhat_diff <- dover_sable_bhat_hist %>%
  left_join(dover_sable_bhat_fut,by = c("port_name", "esm", "sim")) %>%
  mutate(bhatd=bhat_fut-bhat_hist) %>%
  group_by(port_name,esm) %>%
  summarise(meandiff=mean(bhatd),
            sddiff=sd(bhatd)) %>%
  mutate(lower=meandiff-sddiff,upper=meandiff+sddiff) %>%
  ungroup()

# plot
dover_sable_bhat_plot <- dover_sable_bhat_diff %>%
  mutate(ESM=toupper(esm)) %>%
  filter(port_name%in%c("Astoria","Fort Bragg")) %>%
  ggplot(aes(port_name,meandiff,col=ESM,ymin=lower,ymax=upper))+
  geom_pointrange(position=position_dodge(width=0.2))+
  geom_hline(yintercept=0,linetype=2)+
  scale_color_manual(values=c("#009175","#7E0018","#00C2F9"),guide='none')+
  labs(x="Port Group",y=expression(paste(Delta,"Spatial Overlap")))+
  theme(panel.background = element_rect(color='black'),
        strip.text = element_text(size=10))
```

```{r,fig.height=8,fig.width=6}
dover_sable_cpue_overlap <- plot_grid(dover_sable_reldens,dover_sable_bhat_plot,nrow=2,rel_heights=c(1,0.7),labels='auto')
dover_sable_cpue_overlap
ggsave(here('model output','fig4.png'),dover_sable_cpue_overlap,h=8,w=6)
```

# Supplementary Figures

## Cumulative Depth Distribution

```{r}
cume_depth_all <- purrr::map(list(dover_ens_all,sable_ens_all,ss_ens_all,ls_ens_all),plot_depth_distribution_sims) %>% plot_grid(plotlist=.,labels='auto',ncol=2)

cume_depth_plt <- ggdraw()+
  draw_plot(cume_depth_all)+
  draw_image(here('data','icons','dover_sil.png'),hjust=.27,vjust=-.2,scale=0.15)+
  draw_image(here('data','icons','sablefish_sil.png'),hjust=-.26,vjust=-.2,scale=0.15)+
  draw_image(here('data','icons','shortspine_sil.png'),hjust=.24,vjust=.3,scale=0.15)+
  draw_image(here('data','icons','longspine_sil.png'),hjust=-.26,vjust=.3,scale=0.15)
cume_depth_plt

ggsave(here('model output','four_spp_cume_depth_sims.png'),cume_depth_plt,w=8,h=6)
```

## Other ESMs Environmental Change

```{r}
coast_t_o_hist_hadl <- roms %>% 
  dplyr::select(mean_bt_30d_hadl,mean_oxy_bottom_30d_hadl,latitude,longitude,year) %>% 
  filter(year%in%c(1985:2010)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t=mean(mean_bt_30d_hadl),oxy=mean(mean_oxy_bottom_30d_hadl)) %>% 
  ungroup() 
coast_t_o_fut_hadl <- roms %>% 
  dplyr::select(mean_bt_30d_hadl,mean_oxy_bottom_30d_hadl,latitude,longitude,year) %>% 
  filter(year%in%c(2075:2100)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t_fut=mean(mean_bt_30d_hadl),oxy_fut=mean(mean_oxy_bottom_30d_hadl)) %>% 
  ungroup()
coast_t_o_hadl <- coast_t_o_hist_hadl %>% 
  left_join(coast_t_o_fut_hadl,by=c("longitude","latitude")) %>% 
  mutate(diff_t=t_fut-t,diff_o=oxy_fut-oxy)

t_o_grid_hadl <- gr_xy %>% as_tibble() %>% mutate(diff_t=coast_t_o_hadl$diff_t[nns],diff_o=coast_t_o_hadl$diff_o[nns])

coast_t_plot_hadl <- t_o_grid_hadl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_t))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"T")))+
  theme(legend.position = c(0.4,0.6))

coast_o_plot_hadl <- t_o_grid_hadl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_o))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"O")))+
  theme(legend.position = c(0.4,0.6))
coast_t_o_plot_hadl <- plot_grid(coast_t_plot_hadl,NULL,coast_o_plot_hadl,ncol=1,rel_heights = c(1,-0.1,1))
```

```{r}
coast_t_o_hist_gfdl <- roms %>% 
  dplyr::select(mean_bt_30d_gfdl,mean_oxy_bottom_30d_gfdl,latitude,longitude,year) %>% 
  filter(year%in%c(1985:2010)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t=mean(mean_bt_30d_gfdl),oxy=mean(mean_oxy_bottom_30d_gfdl)) %>% 
  ungroup() 
coast_t_o_fut_gfdl <- roms %>% 
  dplyr::select(mean_bt_30d_gfdl,mean_oxy_bottom_30d_gfdl,latitude,longitude,year) %>% 
  filter(year%in%c(2075:2100)) %>% 
  group_by(longitude,latitude) %>% 
  summarise(t_fut=mean(mean_bt_30d_gfdl),oxy_fut=mean(mean_oxy_bottom_30d_gfdl)) %>% 
  ungroup()
coast_t_o_gfdl <- coast_t_o_hist_gfdl %>% 
  left_join(coast_t_o_fut_gfdl,by=c("longitude","latitude")) %>% 
  mutate(diff_t=t_fut-t,diff_o=oxy_fut-oxy)

t_o_grid_gfdl <- gr_xy %>% as_tibble() %>% mutate(diff_t=coast_t_o_gfdl$diff_t[nns],diff_o=coast_t_o_gfdl$diff_o[nns])

coast_t_plot_gfdl <- t_o_grid_gfdl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_t))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"T")))+
  theme(legend.position = c(0.4,0.6))

coast_o_plot_gfdl <- t_o_grid_gfdl %>% 
  ggplot()+
  geom_raster(aes(X,Y,fill=diff_o))+
  geom_sf(data=coast,col=NA)+
  scale_fill_viridis()+
  coord_sf(datum=NA)+
  labs(x="",y="",fill=expression(paste(Delta,"O")))+
  theme(legend.position = c(0.4,0.6))
# 
# coast_t_o_plot <- plot_grid(coast_t_plot,NULL,coast_o_plot,nrow=1,rel_widths = c(1,-0.7,1))
coast_t_o_plot_gfdl <- plot_grid(coast_t_plot_gfdl,NULL,coast_o_plot_gfdl,ncol=1,rel_heights = c(1,-0.1,1))
```

```{r,fig.height=7,fig.width=10}
fig_hadl_gfdl_ipsl_change <- plot_grid(coast_t_o_plot,coast_t_o_plot_gfdl,coast_t_o_plot_hadl,ncol=3,labels=c("IPSL","GFDL","HADL"))
fig_hadl_gfdl_ipsl_change
ggsave(here::here('model output','ESMs_env_change.png'),fig_hadl_gfdl_ipsl_change,h=7,w=10)
```

## Bhattacharyya's and CPUE Change

Calculate CPUE and Bhattacharyya's coefficient between Dover sole and sablefish for all footprints (similar to Fig. 4)

```{r,fig.width=8,fig.height=6}
dover_sable_reldens_all <- allspp_reldens %>% 
  filter(spp %in% c('dover','sable')) %>% 
  ggplot(aes(delta_perc,fill=spp_plotting))+
  geom_density()+
  geom_vline(xintercept=0,linetype=2)+
  scale_fill_manual(values=pal4)+
  facet_grid(ESM~port_name)+
  labs(x=expression(paste(Delta,"CPUE")),y="Kernel Density",fill="")+
  theme(legend.position = 'bottom',
        strip.text = element_text(size=10),
        panel.background = element_rect(color='black'))

dover_sable_reldens_all
ggsave(here::here('model output','dover_sable_cpue_all_footprints.png'),dover_sable_reldens_all,h=7,w=10)
```

```{r}
dover_sable_bhat_plot_all_fps <- dover_sable_bhat_diff %>%
  mutate(ESM=toupper(esm)) %>%
  # filter(port_name%in%c("Astoria","Fort Bragg")) %>%
  ggplot(aes(port_name,meandiff,ymin=lower,ymax=upper))+
  geom_pointrange()+
  geom_hline(yintercept=0,linetype=2)+
  facet_wrap(~ESM,nrow=3)+
  labs(x="Port Group",y=expression(paste(Delta,"Overlap")))+
  theme(panel.background = element_rect(color='black'),
        strip.text = element_text(size=10))
dover_sable_bhat_plot_all_fps
ggsave(here::here('model output','dover_sable_bhat_all_footprints.png'),dover_sable_bhat_plot_all_fps,h=7,w=10)
```

## Commercial Importance of DTS

From PacFIN data extracted and organized by Sean Matson, 12/2022

```{r}
dts_prop_landings_plot <- dts_landings %>% 
  ggplot(aes(PACFIN_YEAR,proportion))+
  geom_line()+
  labs(x="Year",y="DTS Proportion of All Trawl Groundfish")
dts_prop_landings_plot
ggsave(here('model output','fig_dts_landings_prop.png'),dts_prop_landings_plot,h=5,w=6)
```

```{r}
# landings
landings_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T)) %>% 
  ggplot(aes(Year,tot_dollars/1e6,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Landings (Million $)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.13,0.75),
        legend.text = element_text(size=10),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
landings_plot
ggsave(here('model output','fig_dts_landings_rev.png'),landings_plot,h=5,w=6)

#price per pound
ppp_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T),
            tot_lbs=sum(Pounds,na.rm=T)) %>% 
  mutate(ppp=tot_dollars/tot_lbs) %>% 
  ggplot(aes(Year,ppp,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Price Per Pound ($)",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.15,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
ppp_plot
ggsave(here('model output','fig_dts_price.png'),ppp_plot,h=5,w=6)

lbs_plot <- v %>% 
  group_by(Year,lab)%>% 
  filter(Year>1979) %>% 
  summarise(tot_dollars=sum(Dollars,na.rm=T),
            tot_lbs=sum(Pounds,na.rm=T)) %>% 
  mutate(ppp=tot_dollars/tot_lbs) %>% 
  ggplot(aes(Year,tot_lbs/1000,color=lab))+geom_line(size=1.5)+
  labs(x="Year",y="Thousand Pounds",color="")+
  # scale_x_continuous(breaks=seq(2010,2020,by=2))+
  scale_color_manual(values=pal4)+
  scale_x_continuous(expand=c(0,2))+
  theme(legend.position = c(0.85,0.8),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12),
        panel.border = element_rect(color='black',fill=NA))
lbs_plot

ggsave(here('model output','fig_dts_landings_lbs.png'),lbs_plot,h=4,w=6.5)
```